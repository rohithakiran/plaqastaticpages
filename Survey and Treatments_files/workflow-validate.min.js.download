var integerRegEX=/^[+\-]?\d+$/;var answerValidatorMap={};var last_expression_questionId;var form_expressions_valid=true;var specialSymbolPattern=new RegExp("[`~!@#$^&*()=|{}':;',\\[\\].<>《》/?~！@#￥……&*（）——|{}【】‘；：”“'。，、？ ]");var workflow_validate_enabled=true;function preventValidation(){workflow_validate_enabled=false;setTimeout(function(){workflow_validate_enabled=true},600)}function validateData(element,val,questionId,ignore_expression_validator){if(!workflow_validate_enabled){return true}var info,field=$(element),message="",businessDataType=field.attr("businessDataType"),dataType=field.attr("dataType"),answerType=field.attr("answerType"),isRequiredFld=!!(field.attr("required")),answerRequired=field.attr("answerRequired"),fldName=field.attr("name"),maxLength=field.attr("maxlengthText"),minLength=field.attr("minlengthText");var validator=answerValidatorMap[questionId];var answerValidator=eval("("+validator+")");setLastExpressionQuestionId();if(answerType==="checkbox"||answerType==="radio"){var fldValue=$('input[name="'+fldName+'"]:checked').val();if(answerRequired){if(fldValue){isRequiredFld=false}else{isRequiredFld=true}}}if(isRequiredFld&&(!val||(typeof(val)==="undefined"))){info=answerRequiredText}else{if(val&&val.trim()!==""&&maxLength&&val.length>maxLength){message=answerMaximumText.replace("{0}",maxLength)}if(val&&val.trim()!==""&&minLength&&val.length<minLength){message=answerMinimumText.replace("{0}",minLength)}if(answerType==="textfield"||answerType==="textbox"||answerType==="textarea"){if(dataType==="long"||dataType==="integer"){info=numberFieldValidator(field,val,answerValidator,integerRegEX,businessDataType,ignore_expression_validator)}else{if(dataType==="bigdecimal"){info=textFieldCurrencyValidator(field,val,answerValidator,businessDataType,ignore_expression_validator)}else{if(dataType==="date"){if(isNaN(val)&&!isNaN(Date.parse(val))){info=validateDataByValidators(field,val,answerValidator,businessDataType,ignore_expression_validator)}else{if(!isRequiredFld){info=true}else{info=answerDateText}}}else{info=validateDataByValidators(field,val,answerValidator,businessDataType,ignore_expression_validator)}}}}else{info=validateDataByValidators(field,val,answerValidator,businessDataType,ignore_expression_validator)}}if(message&&message.trim()!=""){if(info&&info!==true){info=message+" "+info}else{info=message}}let isValid=appendError(field,(info&&info===true),info,answerType);appendErrorTopOfPage();return isValid}function numberFieldValidator(f,e,a,c,d,b){if(e&&e.trim()!==""){if(!c.test(e)){return answerNumberText}}if(a!=null&&a.length>0){return validateDataByValidators(f,e,a,d,b)}return true}function booleanFiledValidator(e,a,c,b){var d;if(e&&e.trim()!==""){d=e.trim().toLowerCase();if(!(d==="yes"||d==="no")){return answerBooleanText}}if(a!=null&&a.length>0){return validateDataByValidators(e,a,c,b)}return true}function textFieldCurrencyValidator(f,e,a,d,b){var c=/^[+\-]?\d+(.\d{1,})?$/;if(e&&e.trim()!=""){if(e.split(",").length>1){return answerDecimalText}if(e.match(c)){if(e.length>30){return answerDecimalText}}else{return answerDecimalText}}if(a!=null&&a.length>0){return validateDataByValidators(f,e,a,d,b)}return true}function validateDataByValidators(f,g,c,d,h){if(c!=null&&c.length>0){for(var b=0,e=c.length;b<e;b++){var j=c[b],a=true;if(g&&(j.regularExp&&j.regularExp!=="null"&&j.regularExp!=="")){a=validateRegularExpression(j,g)}else{if(j.expression&&j.expression!="null"&&j.expression!==""){if(h){continue}else{a=validateExpression(f,j,g,d)}}else{if(g&&((j.numberValue&&j.numberValue!="null")||(j.minimumValue&&j.minimumValue!="null")||(j.maximumValue&&j.maximumValue!="null")||(j.numOfDecimalDigits&&j.numOfDecimalDigits!="null"))){a=validateNumber(j,g)}else{if(g&&((j.textValue&&j.textValue!="null")||(j.maximumLength&&j.maximumLength!="null")||(j.minimumLength&&j.minimumLength!="null"))){a=validateText(j,g)}else{if(g&&((j.dateValue&&j.dateValue!=null)||(j.maxDateValue&&j.maxDateValue!="null")||(j.miniDateValue&&j.miniDateValue!="null"))){a=validateDate(j,g)}}}}}if(a===true){continue}else{return a}}}return true}function validateRegularExpression(d,h){if(!d||!d.regularExp||h==null&&h.trim()==""){return true}var c=d.operator,g=d.regularExp,b=d.errorText;b=b.replace(/>/g,">");b=b.replace(/</g,"<");if(g.indexOf("/")==0){g=d.regularExp.replace(/\//,"")}if(g.indexOf("/",g.length-1)!==-1){g=g.substring(0,g.length-1)}if(c==="Contains"||c==="NotContains"){var f=new RegExp(g);if(specialSymbolPattern.test(g)){f=new RegExp("\\"+g)}var a=h.match(f);if(c==="Contains"&&(a==null||a.length==0)){return b}else{if(c==="NotContains"&&(a!=null&&a.length>0)){return b}}}else{if(c==="StartWith"||c==="NotStartWith"){var e=g;if(g.indexOf("^")!=0){e="^"+g}var f=new RegExp(e),a=f.test(h);if(c==="StartWith"&&!a){return b}else{if(c==="NotStartWith"&&a){return b}}}else{if(c==="EndWith"||c==="NotEndWith"){var e=g;if(g.indexOf("$")==-1){e=g+"$"}var f=new RegExp(e),a=f.test(h);if(c==="EndWith"&&!a){return b}else{if(c==="NotEndWith"&&a){return b}}}else{if(c==="Matches"||c==="NotMatches"){var f=new RegExp(g),a=f.test(h);if(c==="Matches"&&!a){return b}else{if(c==="NotMatches"&&a){return b}}}}}}return true}function validateExpressionSubmission(a){let servletPathType=servletPath.split("/flow/")[1],urlStr=servletPath.split("/"),wStepId=$("#wStepId").val(),reId=$("#reId").val(),url,data=getValues()||{},result=true;if(urlStr.indexOf("nonAuthenticated")!=-1){url=pageContextPath+"/nonAuthenticated/expressionValidatorSubmission"}else{url=pageContextPath+"/expressionValidatorSubmission"}if(last_expression_questionId){data.wStepId=wStepId;data.reId=reId;data.servletPathType=servletPathType;data.ignore=a.join(",");$.ajax({url:url,method:"POST",async:false,data:data,dataType:"json",success:function(b){result=b.valid;if(!result){for(let questionId in b.data){let _field=$("#answer_"+questionId);if(_field&&!_field.hasClass("validate-failed")){appendError(_field,result,b.data[questionId])}}}}})}return result}function validateExpression(field,validator,value,businessDataType){var servletPathType=servletPath.split("/flow/")[1];if(!validator){return true}var expression=validator.expression,errorText=validator.errorText,wStepId=$("#wStepId").val(),reId=$("#reId").val(),data=getValues()||{},ret=true,url;var urlStr=servletPath.split("/");if(urlStr.indexOf("nonAuthenticated")!=-1){url=pageContextPath+"/nonAuthenticated/expressionValidator"}else{url=pageContextPath+"/expressionValidator"}errorText=errorText.replace(/>/g,">");errorText=errorText.replace(/</g,"<");if(expression){data.expr=expression;data.answer=value;data.bdt=businessDataType;data.wStepId=wStepId;data.reId=reId;data.servletPathType=servletPathType;let _field_name=field.attr("name");let questionId=_field_name.substring(_field_name.indexOf("[")+1,_field_name.indexOf("]"));$.ajax({url:url,method:"POST",async:true,data:data,success:function(result){try{var res=eval("("+result+")");if(res){ret=res.data}}catch(e){ret=false}form_expressions_valid=form_expressions_valid&&ret;appendError(field,ret,errorText)}})}if(!ret){return errorText}return ret}function validateNumber(c,g){if(!c||!g){return true}var d=this,f=parseFloat(g),b=c.operator,a=c.errorText;a=a.replace(/>/g,">");a=a.replace(/</g,"<");if(b==="Between"||b==="NotBetween"){var e=Math.min(c.minimumValue,c.maximumValue),h=Math.max(c.minimumValue,c.maximumValue);if(b==="Between"&&!(f>=e&&f<=h)){return a}else{if(b==="NotBetween"&&(f>=e&&f<=h)){return a}}}else{if(b===">"&&!(f>c.numberValue)){return a}else{if(b===">="&&!(f>=c.numberValue)){return a}else{if(b==="<"&&!(f<c.numberValue)){return a}else{if(b==="<="&&!(f<=c.numberValue)){return a}else{if(b==="="&&(f!=c.numberValue)){return a}else{if((b==="!="||b==="<>")&&f==c.numberValue){return a}}}}}}}return true}function validateText(c,e){if(!c||!e){return true}var d=this,b=c.operator,a=c.errorText;a=a.replace(/>/g,">");a=a.replace(/</g,"<");if(b==="Contains"){if(e.indexOf(c.textValue)<0){return a}}else{if(b==="NotContains"){if(e.indexOf(c.textValue)>=0){return a}}else{if(b==="MaxLength"&&e.length>c.maximumLength){return a}else{if(b==="MinLength"&&e.length<c.minimumLength){return a}}}}return true}function validateDate(d,g){if(!d||!g){return true}var f=new Date(g),c=new Date(d.dateValue),b=d.operator,a=d.errorText;a=a.replace(/>/g,">");a=a.replace(/</g,"<");if(b==="Between"||b==="NotBetween"){var e=new Date(d.miniDateValue),h=new Date(d.maxDateValue);if(h>e){e=e;h=h}else{e=h;h=e}if(b==="Between"&&!(f>=e&&f<=h)){return a}else{if(b==="NotBetween"&&(f>=e&&f<=h)){return a}}}else{if(b===">"&&!(f>c)){return a}else{if(b===">="&&!(f>=c)){return a}else{if(b==="<"&&!(f<c)){return a}else{if(b==="<="&&!(f<=c)){return a}else{if(b==="="&&(f-c)!=0){return a}else{if((b==="!="||b==="<>")&&f-c==0){return a}}}}}}}return true}function getValues(){var a=$("#surveyAndTreatmentForm :input");var b={};a.each(function(){let inputType=this.type.toLowerCase();if("button"!=inputType&&inputType!="submit"&&inputType!="cancel"&&inputType!="image"){var c=$(this).attr("w-id");if(c){b[c]=$(this).val()}}});return b}function checkUploadFile(c,a,e){let field=$(c);let fileName=field.val();let types=e?e.split(","):[],rule="",flag=true,allowAllType=false,isRequiredFld=!!field.attr("required"),message;if(isRequiredFld&&!fileName){message=answerRequiredText;flag=false}else{if(fileName){for(var b=0;b<types.length;b++){var d=types[b].toUpperCase().trim();switch(d){case"PDF":rule+="pdf|PDF|";break;case"EXCEL":rule+="xls|XLS|xlsx|XLSX|";break;case"WORD":rule+="doc|DOC|docx|DOCX|";break;case"TXT":rule+="txt|TXT|";break;case"JPG":rule+="jpg|JPG|jpeg|JPEG";break;case"BMP":rule+="bmp|BMP|";break;case"GIF":rule+="gif|GIF|";break;case"PNG":rule+="png|PNG|";break;case"ZIP":rule+="zip|ZIP|";break;case"HTML":rule+="html|HTML|";break;case"MSG":rule+="msg|MSG|";break;case"ALL":allowAllType=true;break}}if(fileName&&rule){flag=allowAllType?true:hasExtension(fileName,rule.substr(0,rule.length-1))}if(!flag){message=invalidUploadFile.replace("{0}",e)}}}appendError(field,flag,message);return flag}function appendError(e,d,a,b){let _field_name=e.attr("name"),_field_id=e.attr("id");let questionId=_field_name.substring(_field_name.indexOf("[")+1,_field_name.indexOf("]"));if(d&&d===true){e.removeClass("validate-failed");e.attr("aria-invalid",false);var c="answer_"+questionId+"_error";var f=e.attr("aria-describedby");if(f&&f.indexOf(c)>-1){if(f.split(" ").length>1){e.attr("aria-describedby",(f.replace(c,"")).trim())}else{e.removeAttr("aria-describedby")}}let errorFld=$("#"+c);errorFld.html("");errorFld.css("display","none");return d}else{e.addClass("validate-failed");let error_field_id="answer_"+questionId+"_error",errorFld=$("#answer_"+questionId+"_error");if(!errorFld||errorFld.length==0){let errorInfo='<label id="'+error_field_id+'" class="no_top_margin text_red bg_light_blue wfl-validation-error" >'+a+"</label>";if(b&&(b==="radio"||b==="checkbox")){let _parent=e.parent().parent();$(errorInfo).insertAfter(_parent);_append_screen_reader(b,_parent,error_field_id)}else{if("date"==e.attr("dataType")){$(errorInfo).insertAfter(e.closest("span.date-row"))}else{$(errorInfo).insertAfter(e);_append_screen_reader(b,e,error_field_id)}}}else{errorFld.css("display","block");errorFld.html(a);if(b&&(b==="radio"||b==="checkbox")){let _parent=e.parent().parent();_append_screen_reader(b,_parent,error_field_id)}else{_append_screen_reader(b,e,error_field_id)}}return false}}function _append_screen_reader(a,c,b){var d=c.attr("aria-describedby");c.attr("aria-invalid",true);if(d&&d.indexOf(b)<0){c.attr("aria-describedby",d+" "+b)}else{c.attr("aria-describedby",b)}}function setLastExpressionQuestionId(){if(typeof last_expression_questionId!="undefined"&&last_expression_questionId){return last_expression_questionId}let last_question_ID;for(let k in answerValidatorMap){if(k&&answerValidatorMap[k]){let validations=eval("("+answerValidatorMap[k]+")");for(let i=0;i<validations.length;i++){const validation=validations[i];if(validation&&validation.expression&&validation.expression!="null"&&validation.expression!=""){last_question_ID=k}}}}last_expression_questionId=last_question_ID;return last_question_ID}function hasExtension(c,d){var a=".("+d+")$";var b=new RegExp(a);return b.test(c.toUpperCase())}function appendErrorTopOfPage(){if($(".wfl-validation-error").text().trim().indexOf(answerRequiredText)>-1){if($("#error-box").css("display")!=="block"){$("#error-box").css("display","block");$("#error_text").text(moreErrorsText)}}else{$("#error-box").css("display","none");$("#error_text").empty()}}function isValidForm(){form_expressions_valid=true;var c=$("#surveyAndTreatmentForm :input"),b=true,e=[],a=[];setLastExpressionQuestionId();c.each(function(){let inputType=this.type.toLowerCase();if("button"!=inputType&&inputType!="submit"&&inputType!="cancel"&&inputType!="image"){let documentContentType=$(this).attr("documentContentType"),fldValue=$(this).val(),fldName=$(this).attr("name"),disabled=$(this).attr("disabled"),ignore=$(this).hasClass("ignore"),ignore_validation=disabled||ignore;if(fldName){let questionId=fldName.substring(fldName.indexOf("[")+1,fldName.indexOf("]"));if(ignore_validation&&questionId){a.push(questionId)}else{if(inputType!=="hidden"){if("checkbox"==inputType||"radio"==inputType){fldValue=$('input[name="'+fldName+'"]:checked').val()}if(inputType=="file"){b=checkUploadFile(this,parseInt(questionId),documentContentType)}else{b=validateData(this,fldValue,parseInt(questionId),true)}}}}if(!b){e.push(b)}}});let valid=e.length==0&&form_expressions_valid;if(last_expression_questionId){let result=validateExpressionSubmission(a);valid=valid&&result}if(a.length!=0){let $_ignore_field=$("#answer_ignore");if($_ignore_field[0]){$_ignore_field.val(a)}else{$("#surveyAndTreatmentForm").append("<input type='hidden' id='answer_ignore' name='answers[ignore]' value='"+a+"'>")}}appendErrorTopOfPage();var d=$(".validate-failed");if(d&&d.length>0){d[0].focus()}form_expressions_valid=true;return valid};